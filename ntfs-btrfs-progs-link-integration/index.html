<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Case study: link C++ standalone executable to another C executable (ntfs2btrfs to btrfs-convert)</title>
  <meta name="description" content="aligned words
">

  <link rel="stylesheet" href="/css/site-dark.css" id="theme-style">
  <link rel="canonical" href="https://kdave.github.io/ntfs-btrfs-progs-link-integration/">
  <link rel="alternate" type="application/rss+xml" title="(void)VOID_MAX;" href="https://kdave.github.io/rss-all.xml" />
  <script type="text/javascript" src="https://kdave.github.io/css/lib.js"></script>
</head>

  <body>
    <header>
	<nav>
		
		
		<a class="navlink" href="/">[index.html]</a>
		
		<a class="navlink" href="/l/">[index-long.html]</a>
		
		<a class="navlink" href="/a/">[about]</a>
		
		<a class="navlink" href="/m/">[more]</a>
		
		<button id="theme-toggle">Switch theme</button>
		<script>
document.getElementById('theme-toggle').addEventListener('click', function() {
	    var currentTheme = document.getElementById('theme-style').getAttribute('href');
	    var newTheme = currentTheme === '/css/site-light.css' ? '/css/site-dark.css' : '/css/site-light.css';
	    document.getElementById('theme-style').setAttribute('href', newTheme);
});
		</script>
	</nav>
	<hr>
</header>

    <div class="page-content">
      <div class="wrapper">
        <script src="http://localhost:35729/livereload.js"></script>
<div class="post">
  <header class="post-header">
    <h1 class="post-title">Case study: link C++ standalone executable to another C executable (ntfs2btrfs to btrfs-convert)</h1>
    [
     DRAFT || 
    date: <i>2024-12-18</i>
    ||
    tags: <i>ntfs,btrfs</i>
    ]
  </header>
  <article class="post-content">
    <p><em>Problem statement</em>: there’s a tool written in C, <code class="language-plaintext highlighter-rouge">btrfs-convert</code>, that
implements conversion from one filesystem to btrfs. For ext2/3/4 and reiserfs
this is done using existing C libraries. There’s a standalone project
<code class="language-plaintext highlighter-rouge">ntfs2btrfs</code> written in C++, not providing a library interface at all, but the
equivalent functionality.</p>

<p><em>The question</em>: can the functionality of <code class="language-plaintext highlighter-rouge">ntfs2btrfs</code> be provided by
<code class="language-plaintext highlighter-rouge">btrfs-convert</code> while minimizing the difficulty of the integration? Ideally
automated with only a few necessary fix-ups.</p>

<ul id="markdown-toc">
  <li><a href="#inputs" id="markdown-toc-inputs">Inputs</a></li>
  <li><a href="#initial-problems" id="markdown-toc-initial-problems">Initial problems</a></li>
  <li><a href="#solution-outline" id="markdown-toc-solution-outline">Solution outline</a></li>
  <li><a href="#create-the-entry-point" id="markdown-toc-create-the-entry-point">Create the entry point</a></li>
  <li><a href="#what-about-the-two-mains" id="markdown-toc-what-about-the-two-mains">What about the two main()s</a></li>
  <li><a href="#final-link" id="markdown-toc-final-link">Final link</a></li>
</ul>

<h1 id="inputs">Inputs</h1>

<p><a href="https://github.com/kdave/btrfs-progs.git"><strong>btrfs-progs.git</strong></a></p>

<ul>
  <li>primary build system and target</li>
  <li>C sources</li>
  <li>autoconf, make</li>
</ul>

<p><a href="https://github.com/maharmstone/ntfs2btrfs"><strong>ntfs2btrfs.git</strong></a></p>
<ul>
  <li>C++ sources</li>
  <li>cmake</li>
</ul>

<p>What can certainly be done is to <code class="language-plaintext highlighter-rouge">git clone</code> the sources, run their respective
configure and build steps and get lots of <code class="language-plaintext highlighter-rouge">.o</code> files.</p>

<h1 id="initial-problems">Initial problems</h1>

<p>The <code class="language-plaintext highlighter-rouge">ntfs2btrfs</code> conversion tool is in a different repository, git submodules
are not an option so this needs to be cloned and pulled at the time
<code class="language-plaintext highlighter-rouge">btrfs-convert</code> is built.</p>

<p>The other build system should be ideally run without any additional hurdles,
so we can assume it’s in a known separate directory and produces the object files
we’ll use later. But this also builds a standalone executable, so there’s
a symbol <code class="language-plaintext highlighter-rouge">main</code> defined, which will collide with the one defined by the
<code class="language-plaintext highlighter-rouge">btrfs-convert</code> sources.</p>

<p>The language difference is not that significant but in the glue interface
we need to handle potential name mangling or other symbol duplication.</p>

<p>There are duplicate implementations of low-level functions like checksumming.
The estimated size is tens of kilobytes, so we won’t mind that as long as
the linker is able to resolve everything.</p>

<h1 id="solution-outline">Solution outline</h1>

<p>To integrate the projects the steps will be in a script that will basically:</p>

<ul>
  <li>clone the <code class="language-plaintext highlighter-rouge">ntfs2btrfs.git</code> repository</li>
  <li>configure it and build with some sane options (preferring maximum compatibility)</li>
  <li>grab the resulting <code class="language-plaintext highlighter-rouge">.o</code> files</li>
  <li>link <code class="language-plaintext highlighter-rouge">btrfs-convert</code> and the <code class="language-plaintext highlighter-rouge">.o</code> files</li>
</ul>

<p>The last point can be tricky and the missing part is how to hand over
the functionality.</p>

<h1 id="create-the-entry-point">Create the entry point</h1>

<p>The entry point of the standalone <code class="language-plaintext highlighter-rouge">ntfs2btrfs</code> utility is <code class="language-plaintext highlighter-rouge">main</code> so we need
to inject a public function that will not be a mangled as symbol, export
it in a header and use it from <code class="language-plaintext highlighter-rouge">btrfs-convert</code>.</p>

<p>Also we may need to translate the user options set as command line options.
They’ll be parsed in the <code class="language-plaintext highlighter-rouge">ntfs2btrfs</code> project and passed as parameters to the
glue function and mapped to the conversion options if possible. There’s some
feature mismatch so this is not 1:1.</p>

<p>Minimal glue function (:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">extern</span> <span class="s">"C"</span> <span class="p">{</span>
        <span class="kt">void</span> <span class="n">convert_entry</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fn_c</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">enum</span> <span class="n">btrfs_compression</span> <span class="n">compression</span><span class="p">;</span>
                <span class="k">enum</span> <span class="n">btrfs_csum_type</span> <span class="n">csum_type</span><span class="p">;</span>
                <span class="kt">bool</span> <span class="n">nocsum</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

                <span class="n">csum_type</span> <span class="o">=</span> <span class="n">btrfs_csum_type</span><span class="o">::</span><span class="n">crc32c</span><span class="p">;</span>
                <span class="n">compression</span> <span class="o">=</span> <span class="n">btrfs_compression</span><span class="o">::</span><span class="n">none</span><span class="p">;</span>

                <span class="n">string</span> <span class="n">fn</span><span class="p">(</span><span class="n">fn_c</span><span class="p">);</span>
                <span class="n">ntfs</span> <span class="n">dev</span><span class="p">(</span><span class="n">fn</span><span class="p">);</span>

                <span class="n">convert</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">compression</span><span class="p">,</span> <span class="n">csum_type</span><span class="p">,</span> <span class="n">nocsum</span><span class="p">);</span>
        <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This can be appended/included to the main file so it lives in the scope of the
<code class="language-plaintext highlighter-rouge">ntfs2btrfs</code> where its <code class="language-plaintext highlighter-rouge">main()</code> is, so we have access to the translation unit
static and global variables (that can store the representation of the command
line options).</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'#include "convert-entry.c"'</span> <span class="o">&gt;&gt;</span> <span class="s2">"ntfs2btrfs.git/src/ntfs2btrfs.cpp"</span>
</code></pre></div></div>

<p>Symbol name mangling is avoided by <code class="language-plaintext highlighter-rouge">extern "C"</code>, otherwise the parameters are
set to defaults for simplicity. The path of the file/device must be translated
to a C++ <code class="language-plaintext highlighter-rouge">string</code> but this happens inside the glue function, no
interoperability problems. After creation of the filesystem object <code class="language-plaintext highlighter-rouge">ntfs</code> we
can finally hand control to <code class="language-plaintext highlighter-rouge">convert()</code>.</p>

<p>There are some assumptions. The conversion detects the NTFS signature and does
other validation of the image as we’ll call that from <code class="language-plaintext highlighter-rouge">btrfs-convert</code>
unconditionally.</p>

<h1 id="what-about-the-two-mains">What about the two main()s</h1>

<p>Actually this is not hard at all. Linkage is done by comparing plain string
representations, so we’ll just edit it as needed. The colliding symbol name is
<code class="language-plaintext highlighter-rouge">main</code> so let’s rename it to <code class="language-plaintext highlighter-rouge">MAIN</code>. This is a standard symbol in C++ that’s not
mangled so we can simply find in the right <code class="language-plaintext highlighter-rouge">.o</code> file and change it. We can
use <code class="language-plaintext highlighter-rouge">sed</code>.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nm build/.../ntfs2btrfs.o | <span class="nb">grep </span>main
00000000000140ed T main
...
<span class="nv">$ </span><span class="nb">sed</span> <span class="nt">-i</span> <span class="nt">-e</span> <span class="s1">'s/main/MAIN/'</span> build/.../ntfs2btrfs.o
<span class="nv">$ </span>nm build/.../ntfs2btrfs.o | <span class="nb">grep </span>MAIN
00000000000140ed T MAIN
...
</code></pre></div></div>

<p>This is crude and renames several other symbols like lambdas and templates of
<code class="language-plaintext highlighter-rouge">std::basic_string</code> (<code class="language-plaintext highlighter-rouge">00000000000174c9 t
std::__cxx11::basic_string&lt;MAIN::{lambda()#1}::operator()()
const::FMT_COMPILE_STRING::char_type, ...</code>). I haven’t found a standard utility
to that so <code class="language-plaintext highlighter-rouge">sed</code> it is, fortunately there’s no other string <code class="language-plaintext highlighter-rouge">main</code> in the
binary e.g. in an error message.</p>

<h1 id="final-link">Final link</h1>

<p>No remaining problems, we have a bunch of <code class="language-plaintext highlighter-rouge">.o</code> files, no conflicting symbol
names, one executable entry point <code class="language-plaintext highlighter-rouge">main</code> and one final binary. So we now can
link <code class="language-plaintext highlighter-rouge">btrfs-convert</code> with all the other objects. This is basic makefile
integration, not that interesting, also some conditional build support in the
<code class="language-plaintext highlighter-rouge">btrfs-convert</code> sources. With everything in place</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./btrfs-convert <span class="nt">--help</span>
...
    Supported filesystems:
        ext2/3/4: <span class="nb">yes
        </span>reiserfs: no
        ntfs: <span class="nb">yes</span>
<span class="nv">$ </span>mkfs.ntfs /dev/sdx
<span class="nv">$ </span>./btrfs-convert /dev/sdx
btrfs-convert from btrfs-progs v6.12
...
Using CRC32C <span class="k">for </span>checksums.
</code></pre></div></div>

<p>And the last question: <em>does anybody what that?</em></p>

  </article>
</div>

      </div>
    </div>
    <footer class="site-footer">
	<hr>
	&#9993;
	|
<svg xmlns="http://www.w3.org/2000/svg" id="Layer_1" viewBox="0 0 47.999998 48.000002" width="16" height="16"><style id="style3">.Round_x0020_Corners_x0020_2_x0020_pt{fill:#FFF;stroke:#000;stroke-miterlimit:10}.Live_x0020_Reflect_x0020_X{fill:none}.Bevel_x0020_Soft{fill:url(#SVGID_1_)}.Dusk{fill:#FFF}.Foliage_GS{fill:#FD0}.Pompadour_GS{fill:#44ade2}.Pompadour_GS,.st0{fill-rule:evenodd;clip-rule:evenodd}.st0{fill:#191717}</style><linearGradient id="SVGID_1_" gradientUnits="userSpaceOnUse" x1="-216.625" y1="-385.75" x2="-215.918" y2="-385.043"><stop offset="0" id="stop6" stop-color="#dedfe3"/><stop offset=".174" id="stop8" stop-color="#d8d9dd"/><stop offset=".352" id="stop10" stop-color="#c9cacd"/><stop offset=".532" id="stop12" stop-color="#b4b5b8"/><stop offset=".714" id="stop14" stop-color="#989a9c"/><stop offset=".895" id="stop16" stop-color="#797c7e"/><stop offset="1" id="stop18" stop-color="#656b6c"/></linearGradient><path class="st0" d="M23.928 1.15C11 1.15.514 11.638.514 24.566c0 10.343 6.75 19.105 15.945 22.265 1.148.144 1.58-.574 1.58-1.15v-4.02c-6.465 1.436-7.902-3.16-7.902-3.16-1.005-2.73-2.586-3.45-2.586-3.45-2.154-1.435.144-1.435.144-1.435 2.298.144 3.59 2.442 3.59 2.442 2.156 3.59 5.46 2.586 6.753 2.01.142-1.58.86-2.585 1.435-3.16-5.17-.574-10.63-2.585-10.63-11.635 0-2.585.862-4.596 2.442-6.32-.287-.575-1.005-3.017.288-6.177 0 0 2.01-.574 6.464 2.442 1.866-.574 3.877-.718 5.888-.718 2.01 0 4.022.286 5.89.717 4.453-3.016 6.464-2.442 6.464-2.442 1.293 3.16.43 5.602.287 6.177a9.29 9.29 0 0 1 2.44 6.32c0 9.05-5.458 10.918-10.63 11.492.863.718 1.58 2.155 1.58 4.31v6.464c0 .574.432 1.292 1.58 1.15 9.338-3.16 15.946-11.924 15.946-22.266-.143-12.785-10.63-23.27-23.558-23.27z" id="path20" clip-rule="evenodd" fill="#191717" fill-rule="evenodd"/></svg>
	<a href="https://github.com/kdave">github/kdave</a>
	|
<!--
<svg width="16px" height="16px" viewBox="0 0 256 236" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" preserveAspectRatio="xMidYMid">
    <g>
        <path d="M128.07485,236.074667 L128.07485,236.074667 L175.17885,91.1043048 L80.9708495,91.1043048 L128.07485,236.074667 L128.07485,236.074667 Z" fill="#E24329"></path>
        <path d="M128.07485,236.074423 L80.9708495,91.104061 L14.9557638,91.104061 L128.07485,236.074423 L128.07485,236.074423 Z" fill="#FC6D26"></path>
        <path d="M14.9558857,91.1044267 L14.9558857,91.1044267 L0.641828571,135.159589 C-0.663771429,139.17757 0.766171429,143.57955 4.18438095,146.06275 L128.074971,236.074789 L14.9558857,91.1044267 L14.9558857,91.1044267 Z" fill="#FCA326"></path>
        <path d="M14.9558857,91.1045486 L80.9709714,91.1045486 L52.6000762,3.79026286 C51.1408762,-0.703146667 44.7847619,-0.701927619 43.3255619,3.79026286 L14.9558857,91.1045486 L14.9558857,91.1045486 Z" fill="#E24329"></path>
        <path d="M128.07485,236.074423 L175.17885,91.104061 L241.193935,91.104061 L128.07485,236.074423 L128.07485,236.074423 Z" fill="#FC6D26"></path>
        <path d="M241.193935,91.1044267 L241.193935,91.1044267 L255.507992,135.159589 C256.813592,139.17757 255.38365,143.57955 251.96544,146.06275 L128.07485,236.074789 L241.193935,91.1044267 L241.193935,91.1044267 Z" fill="#FCA326"></path>
        <path d="M241.193935,91.1045486 L175.17885,91.1045486 L203.549745,3.79026286 C205.008945,-0.703146667 211.365059,-0.701927619 212.824259,3.79026286 L241.193935,91.1045486 L241.193935,91.1045486 Z" fill="#E24329"></path>
    </g>
</svg>
	<a href="https://gitlab.com/kdave">gitlab/kdave</a>
	|
	-->
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 216.4144 232.00976"><path d="M211.80734 139.0875c-3.18125 16.36625-28.4925 34.2775-57.5625 37.74875-15.15875 1.80875-30.08375 3.47125-45.99875 2.74125-26.0275-1.1925-46.565-6.2125-46.565-6.2125 0 2.53375.15625 4.94625.46875 7.2025 3.38375 25.68625 25.47 27.225 46.39125 27.9425 21.11625.7225 39.91875-5.20625 39.91875-5.20625l.8675 19.09s-14.77 7.93125-41.08125 9.39c-14.50875.7975-32.52375-.365-53.50625-5.91875C9.23234 213.82 1.40609 165.31125.20859 116.09125c-.365-14.61375-.14-28.39375-.14-39.91875 0-50.33 32.97625-65.0825 32.97625-65.0825C49.67234 3.45375 78.20359.2425 107.86484 0h.72875c29.66125.2425 58.21125 3.45375 74.8375 11.09 0 0 32.975 14.7525 32.975 65.0825 0 0 .41375 37.13375-4.59875 62.915" fill="#3088d4"/><path d="M177.50984 80.077v60.94125h-24.14375v-59.15c0-12.46875-5.24625-18.7975-15.74-18.7975-11.6025 0-17.4175 7.5075-17.4175 22.3525v32.37625H96.20734V85.42325c0-14.845-5.81625-22.3525-17.41875-22.3525-10.49375 0-15.74 6.32875-15.74 18.7975v59.15H38.90484V80.077c0-12.455 3.17125-22.3525 9.54125-29.675 6.56875-7.3225 15.17125-11.07625 25.85-11.07625 12.355 0 21.71125 4.74875 27.8975 14.2475l6.01375 10.08125 6.015-10.08125c6.185-9.49875 15.54125-14.2475 27.8975-14.2475 10.6775 0 19.28 3.75375 25.85 11.07625 6.36875 7.3225 9.54 17.22 9.54 29.675" fill="#fff"/></svg>
	<a href="https://social.kernel.org/kdave">@kdave@social.kernel.org</a>
	|
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px" viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;" xml:space="preserve" width="16" height="16">
<g>
	<path style="fill:#FFB500;" d="M437,0H75C33.645,0,0,33.645,0,75v362c0,41.355,33.645,75,75,75h362c41.355,0,75-33.645,75-75V75   C512,33.645,478.355,0,437,0z M106.176,446.374c-24.293,0-44.057-19.764-44.057-44.056c0-24.293,19.764-44.057,44.057-44.057   s44.057,19.764,44.057,44.057C150.232,426.61,130.469,446.374,106.176,446.374z M255.212,438.281c-22.056,0-40-17.944-40-40   c0-57.898-47.103-105-105-105c-22.056,0-40-17.944-40-40c0-22.056,17.944-40,40-40c102.009,0,185,82.99,185,185   C295.212,420.337,277.269,438.281,255.212,438.281z M405.212,438.281c-22.056,0-40-17.944-40-40   c0-68.112-26.524-132.148-74.688-180.313c-48.163-48.163-112.199-74.688-180.313-74.688c-22.056,0-40-17.944-40-40   c0-22.056,17.944-40,40-40c89.481,0,173.607,34.846,236.881,98.119c63.273,63.273,98.12,147.399,98.12,236.881   C445.212,420.337,427.269,438.281,405.212,438.281z"/>
	<path style="fill:#FF9300;" d="M437,0H257.712v97.335c32.691,16.058,62.871,37.555,89.381,64.065   c63.273,63.273,98.12,147.399,98.12,236.881c0,22.056-17.944,40-40,40c-22.056,0-40-17.944-40-40   c0-68.112-26.524-132.148-74.688-180.313c-10.254-10.254-21.233-19.517-32.812-27.762v96.545   c23.522,31.032,37.5,69.677,37.5,111.53c0,21.215-16.605,38.618-37.5,39.914V512H437c41.355,0,75-33.645,75-75V75   C512,33.645,478.355,0,437,0z"/>
</g>
</svg>
	<a href="/rss-all.xml">RSS</a>
	|
	<img class="img-nav" src="https://kdave.github.io/images/cc-by-sa.svg" />
	Content licensed under <a href="http://creativecommons.org/licenses/by/4.0/">CC BY SA 4.0</a>
</footer>

  </body>
</html>
